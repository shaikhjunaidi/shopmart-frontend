<!DOCTYPE html>
<html lang="en">
<head>
    <title>ShopMart | Admin Dashboard</title>
    <link rel="stylesheet" href="css/style.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* --- ADMIN SPECIFIC STYLES --- */
        
        /* Edit Mode Highlight */
        .editing-mode {
            border: 2px solid var(--accent-orange);
            background-color: #fffdf5 !important;
            transition: all 0.3s ease;
        }
        .edit-preview-img {
            width: 80px; height: 80px; object-fit: cover;
            border-radius: 10px; border: 1px solid #ddd;
            display: block; margin-top: 10px;
        }

        /* Welcome Banner */
        .welcome-banner {
            background: linear-gradient(135deg, #023E36, #035e52);
            color: white;
            padding: 40px;
            border-radius: 20px;
            margin-bottom: 40px;
            box-shadow: 0 10px 30px rgba(2, 62, 54, 0.2);
            text-align: center;
        }
        .welcome-banner h1 {
            font-family: 'Playfair Display', serif;
            font-size: 3rem;
            margin-bottom: 10px;
        }
        .welcome-banner p {
            font-size: 1.1rem;
            opacity: 0.9;
            font-weight: 300;
            letter-spacing: 1px;
        }

        /* Status Badges */
        .status-badge { padding: 4px 10px; border-radius: 20px; font-size: 0.75rem; font-weight: bold; text-transform: uppercase; }
        .status-online { background: #d1fae5; color: #065f46; border: 1px solid #065f46; }
        .status-offline { background: #f3f4f6; color: #6b7280; border: 1px solid #d1d5db; }

        /* Layout Helpers */
        .stats-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        /* Scrollable Lists for Orders/Offers */
        .scroll-box {
            max-height: 400px;
            overflow-y: auto;
            padding-right: 5px;
        }
        /* Custom Scrollbar */
        .scroll-box::-webkit-scrollbar { width: 6px; }
        .scroll-box::-webkit-scrollbar-thumb { background: #ccc; border-radius: 10px; }
        .scroll-box::-webkit-scrollbar-track { background: #f1f1f1; }

        .chart-container {
            position: relative; height: 250px; width: 100%; display: flex; justify-content: center;
        }
    </style>
</head>
<body>
    <header>
        <a href="index.html" class="logo">
            <img src="https://cdn-icons-png.flaticon.com/512/1656/1656850.png" class="logo-icon" alt="Logo">
            <div class="logo-text">Shop<span>Mart</span> Admin</div>
        </a>
        <nav>
            <a href="index.html">Home</a>
            <a href="#" onclick="logout()">Logout</a>
        </nav>
    </header>

    <div class="container">
        
        <div id="admin-welcome" class="welcome-banner"></div>

        <div style="margin-top: 2rem;">
            <h2 class="section-heading">Dashboard Overview</h2>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px;">
                <div class="card" style="text-align:center; border-left: 5px solid green;">
                    <h3 style="font-size:0.9rem; color:#666;">Revenue</h3>
                    <p id="stat-revenue" style="font-size:1.8rem; font-weight:bold; color:var(--primary-dark); margin:10px 0;">‚Çπ0</p>
                </div>
                <div class="card" style="text-align:center; border-left: 5px solid var(--accent-orange);">
                    <h3 style="font-size:0.9rem; color:#666;">Orders</h3>
                    <p id="stat-orders" style="font-size:1.8rem; font-weight:bold; color:var(--primary-dark); margin:10px 0;">0</p>
                </div>
                <div class="card" style="text-align:center; border-left: 5px solid blue;">
                    <h3 style="font-size:0.9rem; color:#666;">Users</h3>
                    <div style="display:flex; justify-content:center; gap:15px; align-items:center;">
                        <div><span style="font-size:0.8rem; color:#666;">Total</span><p id="stat-users" style="font-size:1.5rem; font-weight:bold; color:var(--primary-dark); margin:0;">0</p></div>
                        <div style="border-left:1px solid #ccc; height:30px;"></div>
                        <div><span style="font-size:0.8rem; color:green; font-weight:bold;">‚óè Online</span><p id="stat-active" style="font-size:1.5rem; font-weight:bold; color:green; margin:0;">0</p></div>
                    </div>
                </div>
            </div>
        </div>

        <div class="stats-row">
            <div style="background: #fff3cd; padding: 20px; border-radius: 15px; border: 1px solid #ffeeba;">
                <h3 style="font-size:1.2rem; text-align:center; color:#856404; margin-bottom:15px;">üîî Recent Orders</h3>
                <div id="all-orders-list" class="scroll-box" style="display:grid; gap:15px;">
                    <p style="text-align:center;">Loading orders...</p>
                </div>
            </div>
            
            <div style="display:flex; flex-direction:column; gap:20px;">
                <div class="card">
                    <h3 style="font-size:1.2rem; text-align:center; margin-bottom:15px;">Offer Inbox</h3>
                    <div id="offer-list" class="scroll-box" style="display:grid; gap:10px;">
                        <p style="text-align:center;">Loading...</p>
                    </div>
                </div>
                <div class="card">
                    <h3 style="text-align:center; margin-bottom:10px;">Offer Stats</h3>
                    <div class="chart-container">
                        <canvas id="offerChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <hr style="border:0; border-top:2px solid #eee; margin: 3rem 0;">

        <div style="max-width: 100%; margin: 2rem auto; background: white; padding: 20px; border-radius: 15px; box-shadow: 0 5px 15px rgba(0,0,0,0.05); border: 1px solid #eee;">
            <h2 class="section-heading" style="text-align:left; margin-bottom:15px;">User Management üëÆ</h2>
            <div style="overflow-x:auto; max-height: 400px; overflow-y:auto;">
                <table style="width:100%; border-collapse:collapse;">
                    <thead style="position:sticky; top:0; background:#f4f4f4; z-index:5;">
                        <tr style="text-align:left;">
                            <th style="padding:12px; border-radius:8px 0 0 8px;">Name</th>
                            <th style="padding:12px;">Email</th>
                            <th style="padding:12px;">Status</th>
                            <th style="padding:12px; border-radius:0 8px 8px 0;">Action</th>
                        </tr>
                    </thead>
                    <tbody id="user-list">
                        <tr><td colspan="4" style="text-align:center; padding:20px;">Loading users...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>

        <hr style="border:0; border-top:2px solid #eee; margin: 3rem 0;">

        <div id="form-container" class="form-box" style="max-width:700px; transition:0.3s;">
            <h2 id="form-title" style="font-family:'Playfair Display'; color:var(--primary-dark); text-align:center; margin-bottom:20px;">Add New Product</h2>
            <form id="product-form">
                <input type="hidden" id="edit-id">
                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:20px;">
                    <div><label>Title</label><input type="text" id="p-title" required></div>
                    <div>
                        <label>Category</label>
                        <select id="p-category" required>
                            <option value="General">General</option>
                            <option value="Electronics">Electronics</option>
                            <option value="Fashion">Fashion</option>
                            <option value="Vintage">Vintage</option>
                            <option value="Home">Home</option>
                        </select>
                    </div>
                </div>
                <label>Description</label><textarea id="p-desc" required style="height:80px;"></textarea>
                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:20px;">
                    <div><label>Price (‚Çπ)</label><input type="number" id="p-price" step="0.01" required></div>
                    <div><label>Stock</label><input type="number" id="p-stock" required></div>
                </div>
                <div>
                    <label>Product Image</label>
                    <input type="file" id="p-image" accept="image/*" style="background:white;">
                    <div id="image-preview-container" style="display:none;">
                        <p style="font-size:0.8rem; color:green; margin:5px 0;">Current Image:</p>
                        <img id="preview-img" class="edit-preview-img" src="">
                    </div>
                </div>
                <div style="display:flex; gap:10px; margin-top:25px;">
                    <button type="submit" class="btn" id="submit-btn" style="flex:1;">ADD PRODUCT</button>
                    <button type="button" class="btn" id="cancel-btn" style="background:#666; display:none; flex:1;" onclick="exitEditMode()">CANCEL</button>
                </div>
            </form>
        </div>

        <h2 class="section-heading" style="margin-top:4rem;">Manage Inventory</h2>
        <div id="admin-products" class="product-grid"></div>
    </div>

    <footer>
        <div class="footer-content">
            <div class="footer-col">
                <a href="#" class="logo" style="margin-bottom:15px;">
                    <div class="logo-text">Shop<span>Mart</span></div>
                </a>
                <p style="font-size:0.9rem; color:rgba(255,255,255,0.7); line-height:1.6;">
                    Curated vintage aesthetics for the modern world.
                </p>
            </div>
            <div class="footer-col">
                <h4>Shop</h4>
                <a href="index.html">All Products</a>
                <a href="#">New Arrivals</a>
                <a href="#">Featured</a>
                <a href="#">Deals</a>
            </div>
            <div class="footer-col">
                <h4>Support</h4>
                <a href="#">Help Center</a>
                <a href="#">Shipping Info</a>
            </div>
            <div class="footer-col">
                <h4>Contact Us</h4>
                <a href="mailto:me.junaid.in@gmail.com" style="color:var(--accent-orange); font-weight:bold; display:flex; align-items:center; gap:8px;">
                    ‚úâÔ∏è me.junaid.in@gmail.com
                </a>
                <a href="#" style="display:flex; align-items:center; gap:8px;">üìû +91 98765 43210</a>
                <a href="#" style="display:flex; align-items:center; gap:8px;">üìç Bangalore, India</a>
                <div style="margin-top:15px; display:flex; gap:15px;">
                    <a href="https://www.linkedin.com/in/shaikh-junaid-jd135?utm_source=share&utm_campaign=share_via&utm_content=profile&utm_medium=android_app" 
                       target="_blank" title="LinkedIn" style="font-size:1.4rem;">üíº</a>
                    <a href="#" title="Instagram" style="font-size:1.4rem;">üì∏</a>
                    <a href="#" title="Twitter" style="font-size:1.4rem;">üê¶</a>
                </div>
            </div>
        </div>
        <div class="footer-bottom">
            &copy; 2025 ShopMart Inc. | Built by Junaid
        </div>
    </footer>

    <script src="js/app.js"></script>
    <script>
        if (!getUser() || !getUser().isAdmin) window.location.href = 'index.html';

        let allProducts = []; 

        function setWelcomeMessage() {
            const user = getUser();
            const h = new Date().getHours();
            const greet = h < 12 ? "Good Morning" : h < 18 ? "Good Afternoon" : "Good Evening";
            document.getElementById('admin-welcome').innerHTML = `<h1>${greet}, ${user.name.split(' ')[0]}! üåü</h1><p>Here is what's happening in your store today.</p>`;
        }
        setWelcomeMessage();

        async function loadData() {
            // 1. Stats
            try {
                const statRes = await apiFetch('/stats');
                if(statRes.ok) {
                    const data = await statRes.json();
                    document.getElementById('stat-revenue').innerText = '‚Çπ' + Number(data.revenue).toFixed(0);
                    document.getElementById('stat-orders').innerText = data.total_orders;
                    document.getElementById('stat-users').innerText = data.total_users;
                    document.getElementById('stat-active').innerText = data.active_now;

                    const ctx = document.getElementById('offerChart');
                    if(ctx) {
                        if(window.myChart) window.myChart.destroy();
                        let accepted = 0, rejected = 0, pending = 0;
                        if(data.offer_stats) {
                            data.offer_stats.forEach(s => {
                                if(s.status === 'accepted') accepted = s.count;
                                if(s.status === 'rejected') rejected = s.count;
                                if(s.status === 'pending') pending = s.count;
                            });
                        }
                        window.myChart = new Chart(ctx.getContext('2d'), { type: 'doughnut', data: { labels: ['Accepted', 'Rejected', 'Pending'], datasets: [{ data: [accepted, rejected, pending], backgroundColor: ['#4CAF50', '#F44336', '#FF9800'], borderWidth: 0 }] } });
                    }
                }
            } catch(e) {}

            // 2. Users (Updated with Delete Button)
            try {
                const userRes = await apiFetch('/auth/users');
                const users = await userRes.json();
                const container = document.getElementById('user-list');

                if(users.length === 0) { container.innerHTML = '<tr><td colspan="4" style="text-align:center; padding:20px;">No users found.</td></tr>'; }
                else {
                    container.innerHTML = users.map(u => {
                        const isBanned = u.isBanned === 1;
                        const lastLoginTime = new Date(u.last_login).getTime();
                        const diffMinutes = (new Date().getTime() - lastLoginTime) / 60000;
                        const onlineBadge = diffMinutes < 10 ? '<span class="status-badge status-online">‚óè Online</span>' : `<span style="color:#999; font-size:0.8rem;">‚óã Offline</span>`;
                        const statusBadge = isBanned ? '<span class="status-badge status-offline">Banned</span>' : '<span class="status-badge status-online">Active</span>';
                        const btnText = isBanned ? "Unblock" : "Block";
                        const btnColor = isBanned ? "green" : "red";
                        return `
                            <tr style="border-bottom:1px solid #eee;">
                                <td style="padding:12px;"><strong>${u.name}</strong><br>${onlineBadge}</td>
                                <td style="padding:12px; color:#555;">${u.email}</td>
                                <td style="padding:12px;">${statusBadge}</td>
                                <td style="padding:12px; display:flex; gap:10px;">
                                    <button onclick="toggleBan(${u.id})" style="background:${btnColor}; color:white; border:none; padding:5px 12px; border-radius:4px; cursor:pointer;">${btnText}</button>
                                    <button onclick="deleteUser(${u.id})" style="background:#333; color:white; border:none; padding:5px 12px; border-radius:4px; cursor:pointer;" title="Delete User">üóëÔ∏è</button>
                                </td>
                            </tr>
                        `;
                    }).join('');
                }
            } catch(e) {}

            // 3. Inventory
            try {
                const res = await apiFetch('/products');
                if(res.ok) {
                    allProducts = await res.json();
                    document.getElementById('admin-products').innerHTML = allProducts.length ? allProducts.map(p => {
                        let img = getImgPath(p.image);
                        return `<div class="card"><div class="card-body"><div style="display:flex; justify-content:space-between;"><h4>${p.title}</h4><small>#${p.id}</small></div><img src="${img}" style="width:100%; height:120px; object-fit:contain; margin:10px 0; background:white;"><p style="font-size:0.8rem;">${p.category || 'General'}</p><p style="color:var(--accent-orange);">‚Çπ${p.price}</p><div style="display:flex; gap:10px;"><button class="btn" style="background:#333; flex:1;" onclick="enterEditMode(${p.id})">EDIT</button><button class="btn" style="background:red; flex:1;" onclick="deleteProduct(${p.id})">DELETE</button></div></div></div>`;
                    }).join('') : '<p style="text-align:center;">No products.</p>';
                }
            } catch(e) {}

            // 4. Orders
            try {
                const orderRes = await apiFetch('/orders/admin');
                if(orderRes.ok) {
                    const orders = await orderRes.json();
                    document.getElementById('all-orders-list').innerHTML = orders.length ? 
                        orders.map(o => {
                            let statusColor = o.status === 'Shipped' ? 'blue' : (o.status === 'Delivered' ? 'green' : 'orange');
                            return `<div class="card" style="padding:10px; border-left:5px solid ${statusColor}; margin-bottom:5px; background:white;"><small>#${o.id} - ${o.user_name}</small><br><strong>‚Çπ${o.total_price}</strong><br><select onchange="updateStatus(${o.id}, this.value)" style="margin-top:5px;"><option value="Pending" ${o.status === 'Pending'?'selected':''}>Pending</option><option value="Shipped" ${o.status === 'Shipped'?'selected':''}>Shipped</option><option value="Delivered" ${o.status === 'Delivered'?'selected':''}>Delivered</option><option value="Cancelled" ${o.status === 'Cancelled'?'selected':''}>Cancelled</option></select></div>`;
                        }).join('') : '<p style="text-align:center;">No orders.</p>';
                }
            } catch(e) {}

            // 5. Offers
            try {
                const offerRes = await apiFetch('/offers/admin');
                if(offerRes.ok) {
                    const offers = await offerRes.json();
                    document.getElementById('offer-list').innerHTML = offers.length ?
                        offers.map(o => `<div class="card" style="padding:10px; border-left:4px solid blue; margin-bottom:5px; background:white;"><small>${o.product_title}</small><br><strong>‚Çπ${o.offer_price}</strong><div style="text-align:right;"><button style="color:green; cursor:pointer;" onclick="respondOffer(${o.id}, 'accepted')">‚úì</button> <button style="color:red; cursor:pointer;" onclick="respondOffer(${o.id}, 'rejected')">‚úï</button></div></div>`).join('') : '<p style="text-align:center;">No offers.</p>';
                }
            } catch(e) {}
        }

        async function toggleBan(id) { if(confirm("Change user status?")) { await apiFetch(`/auth/ban/${id}`, { method: 'PUT' }); loadData(); }}
        
        // NEW DELETE USER FUNCTION
        async function deleteUser(id) {
            if(confirm("‚ö†Ô∏è WARNING: This will delete the user AND all their orders/history. Are you sure?")) {
                const res = await apiFetch(`/auth/users/${id}`, { method: 'DELETE' });
                if(res.ok) {
                    alert("User Deleted!");
                    loadData(); 
                } else {
                    const data = await res.json();
                    alert(data.message);
                }
            }
        }

        async function deleteProduct(id) { if(confirm('Delete?')) { await apiFetch(`/products/${id}`, { method: 'DELETE' }); loadData(); }}
        async function updateStatus(id, status) { await apiFetch(`/orders/${id}/status`, { method: 'PUT', body: JSON.stringify({ status }) }); loadData(); }
        async function respondOffer(id, status) { if(confirm(`Mark as ${status}?`)) { await apiFetch(`/offers/${id}`, { method: 'PUT', body: JSON.stringify({ status }) }); loadData(); }}

        function enterEditMode(id) {
            const p = allProducts.find(i => i.id === id);
            if(!p) return;
            window.scrollTo({ top: document.getElementById('form-container').offsetTop - 50, behavior: 'smooth' });
            document.getElementById('form-container').classList.add('editing-mode');
            document.getElementById('form-title').innerText = `Edit: ${p.title}`;
            document.getElementById('submit-btn').innerText = "UPDATE";
            document.getElementById('cancel-btn').style.display = 'inline-block';
            document.getElementById('edit-id').value = p.id;
            document.getElementById('p-title').value = p.title;
            document.getElementById('p-category').value = p.category;
            document.getElementById('p-desc').value = p.description;
            document.getElementById('p-price').value = p.price;
            document.getElementById('p-stock').value = p.stock;
            document.getElementById('image-preview-container').style.display = 'block';
            document.getElementById('preview-img').src = getImgPath(p.image);
            document.getElementById('p-image').required = false;
        }

        function exitEditMode() {
            document.getElementById('form-container').classList.remove('editing-mode');
            document.getElementById('product-form').reset();
            document.getElementById('form-title').innerText = "Add Product";
            document.getElementById('submit-btn').innerText = "ADD";
            document.getElementById('cancel-btn').style.display = 'none';
            document.getElementById('edit-id').value = '';
            document.getElementById('image-preview-container').style.display = 'none';
            document.getElementById('p-image').required = true;
        }

        document.getElementById('product-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const id = document.getElementById('edit-id').value;
            const formData = new FormData();
            formData.append('title', document.getElementById('p-title').value);
            formData.append('category', document.getElementById('p-category').value);
            formData.append('description', document.getElementById('p-desc').value);
            formData.append('price', document.getElementById('p-price').value);
            formData.append('stock', document.getElementById('p-stock').value);
            const file = document.getElementById('p-image').files[0];
            if(file) formData.append('image', file);

            const url = id ? `/products/${id}` : '/products';
            const method = id ? 'PUT' : 'POST';

            const res = await apiFetch(url, { method, body: formData });
            if(res.ok) { alert('Saved!'); exitEditMode(); loadData(); } else { alert('Error'); }
        });

        function getImgPath(image) {
            if (!image) return 'https://via.placeholder.com/300';
            if (image.startsWith('http')) return image;
            return `/uploads/${image}`;
        }

        loadData();
    </script>
</body>
</html>